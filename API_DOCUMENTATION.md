# API Usage Guide - Create Case & Fetch Case Details

## Overview

This guide provides step-by-step instructions for:
1. Creating a case via API
2. Fetching case details and responses via API

---

## Prerequisites

Before using the API, you need:
- **Supabase Project URL**: Get from Supabase Dashboard → Settings → API
- **Supabase Anon Key**: Get from Supabase Dashboard → Settings → API → "anon" key
- **API Key**: Generated by administrator (contact support to get one)

---

## Process 1: Create a Case

### Step 1: Prepare Your Request

**Method:** `POST`

**URL:**
```
https://YOUR_PROJECT_REF.supabase.co/functions/v1/create-case
```

Replace `YOUR_PROJECT_REF` with your actual project reference ID.

### Step 2: Set Up Headers

Add these 4 headers in your API client (Postman, cURL, etc.):

| Header Name | Header Value |
|-------------|--------------|
| `apikey` | Your Supabase anon key |
| `Authorization` | `Bearer YOUR_SUPABASE_ANON_KEY` (same as above, with "Bearer " prefix) |
| `x-api-key` | Your custom API key (provided by administrator) |
| `Content-Type` | `application/json` |

### Step 3: Prepare Request Body

Create a JSON body with the following structure:

```json
{
  "client_case_id": "YOUR-INTERNAL-CASE-ID",
  "contract_type": "business_address_check",
  "candidate_name": "John Doe",
  "phone_primary": "+919876543210",
  "location": {
    "address_line": "123 Main Street",
    "city": "Mumbai",
    "state": "Maharashtra",
    "pincode": "400001"
  },
  "vendor_tat_start_date": "2025-01-20T10:00:00Z",
  "due_at": "2025-01-22T18:00:00Z",
  "tat_hours": 48
}
```

#### Required Fields:
- `client_case_id`: Your internal case identifier
- `contract_type`: Type of verification (e.g., `business_address_check`, `residence_verification`)
- `candidate_name`: Full name of the candidate
- `phone_primary`: Primary contact number
- `location`: Object with `address_line`, `city`, `state`, `pincode`
- `vendor_tat_start_date`: Start date in ISO 8601 format (e.g., "2025-01-20T10:00:00Z")
- `due_at`: Due date in ISO 8601 format
- `tat_hours`: Turnaround time in hours (number)

#### Optional Fields:
- `company_name`: Company name (required for business contracts)
- `phone_secondary`: Secondary contact number
- `base_rate_inr`: Base rate in INR (auto-calculated if not provided)
- `bonus_inr`: Bonus amount
- `penalty_inr`: Penalty amount
- `total_payout_inr`: Total payout (auto-calculated if not provided)
- `instructions`: Special instructions for the case

### Step 4: Send the Request

Send the POST request with the headers and body configured above.

### Step 5: Handle the Response

#### Success Response (201 Created):

```json
{
  "success": true,
  "case": {
    "id": "3903eeee-65bf-47a0-9801-5898e571385d",
    "case_number": "BG-20250120-ABC123",
    "client_case_id": "YOUR-INTERNAL-CASE-ID",
    "status": "new",
    "created_at": "2025-01-20T10:00:00Z",
    "client": { ... },
    "location": { ... }
  }
}
```

**Important:** Save the `id` and `case_number` from the response - you'll need them to fetch case details later.

#### Error Response:

If there's an error, you'll receive a response like:

```json
{
  "error": "Error message",
  "details": "Additional details"
}
```

Common errors:
- **400 Bad Request**: Missing required fields or invalid data
- **401 Unauthorized**: Invalid API key
- **403 Forbidden**: Insufficient permissions
- **500 Internal Server Error**: Server-side error

---

## Process 2: Fetch Case Details

### Step 1: Prepare Your Request

**Method:** `GET`

**URL (Option 1 - By Case ID):**
```
https://YOUR_PROJECT_REF.supabase.co/functions/v1/get-case-details?case_id=CASE_UUID_HERE
```

**URL (Option 2 - By Case Number):**
```
https://YOUR_PROJECT_REF.supabase.co/functions/v1/get-case-details?case_number=BG-20250120-ABC123
```

Replace:
- `YOUR_PROJECT_REF` with your project reference ID
- `CASE_UUID_HERE` with the case ID from the create response, OR
- Use `case_number` parameter with the case number (e.g., `BG-20250120-ABC123`)

### Step 2: Set Up Headers

Add these 3 headers:

| Header Name | Header Value |
|-------------|--------------|
| `apikey` | Your Supabase anon key |
| `Authorization` | `Bearer YOUR_SUPABASE_ANON_KEY` |
| `x-api-key` | Your custom API key |

**Note:** No `Content-Type` header needed for GET requests, and no body is required.

### Step 3: Send the Request

Send the GET request with the headers configured above.

### Step 4: Handle the Response

#### Success Response (200 OK):

```json
{
  "success": true,
  "case": {
    "id": "3903eeee-65bf-47a0-9801-5898e571385d",
    "case_number": "BG-20250120-ABC123",
    "client_case_id": "YOUR-INTERNAL-CASE-ID",
    "status": "submitted",
    "contract_type": "business_address_check",
    "candidate_name": "John Doe",
    "pricing": {
      "base_rate_inr": 500.00,
      "bonus_inr": 0,
      "penalty_inr": 0,
      "total_payout_inr": 500.00
    },
    "timeline": {
      "created_at": "2025-01-20T10:00:00Z",
      "assigned_at": "2025-01-20T11:00:00Z",
      "submitted_at": "2025-01-21T15:00:00Z"
    },
    "client": { ... },
    "location": { ... }
  },
  "form_submissions": [
    {
      "id": "submission-uuid",
      "template_name": "Business Address Check",
      "submission_data": { ... },
      "files": [ ... ]
    }
  ],
  "legacy_submissions": [ ... ],
  "qc_reviews": [ ... ]
}
```

The response includes:
- **case**: Complete case information
- **form_submissions**: Form-based submissions with files (if available)
- **legacy_submissions**: Legacy format submissions (if no form submissions)
- **qc_reviews**: Quality control reviews (if case has been reviewed)

#### Error Response:

```json
{
  "error": "Error message",
  "details": "Additional details"
}
```

Common errors:
- **400 Bad Request**: Missing case_id or case_number parameter
- **401 Unauthorized**: Invalid API key
- **403 Forbidden**: Access denied (case belongs to different client)
- **404 Not Found**: Case not found
- **500 Internal Server Error**: Server-side error

---

## Quick Reference

### Create Case
- **Method:** POST
- **URL:** `/functions/v1/create-case`
- **Headers:** `apikey`, `Authorization`, `x-api-key`, `Content-Type`
- **Body:** JSON with case data

### Get Case Details
- **Method:** GET
- **URL:** `/functions/v1/get-case-details?case_id=UUID` or `?case_number=BG-XXXXX`
- **Headers:** `apikey`, `Authorization`, `x-api-key`
- **Body:** None

---

## Example: Complete Workflow

### 1. Create a Case

**Request:**
```
POST https://your-project.supabase.co/functions/v1/create-case
Headers:
  apikey: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
  Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
  x-api-key: bgv_worCh8KJwpnCjjjCoATClUDCs8Otwpc4w5I4BMKDwpLDnVXCsiI0QT-DiEsWw49kwps
  Content-Type: application/json

Body:
{
  "client_case_id": "TEST-001",
  "contract_type": "business_address_check",
  "candidate_name": "John Doe",
  "phone_primary": "+919876543210",
  "location": {
    "address_line": "123 Main Street",
    "city": "Mumbai",
    "state": "Maharashtra",
    "pincode": "400001"
  },
  "vendor_tat_start_date": "2025-01-20T10:00:00Z",
  "due_at": "2025-01-22T18:00:00Z",
  "tat_hours": 48
}
```

**Response:**
```json
{
  "success": true,
  "case": {
    "id": "3903eeee-65bf-47a0-9801-5898e571385d",
    "case_number": "BG-20250120-ABC123",
    ...
  }
}
```

### 2. Fetch Case Details (using the ID from step 1)

**Request:**
```
GET https://your-project.supabase.co/functions/v1/get-case-details?case_id=3903eeee-65bf-47a0-9801-5898e571385d
Headers:
  apikey: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
  Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
  x-api-key: bgv_worCh8KJwpnCjjjCoATClUDCs8Otwpc4w5I4BMKDwpLDnVXCsiI0QT-DiEsWw49kwps
```

**Response:**
```json
{
  "success": true,
  "case": { ... },
  "form_submissions": [ ... ],
  "qc_reviews": [ ... ]
}
```

---

## Support

If you encounter issues:
1. Verify all headers are correctly set
2. Check that your API key is active
3. Ensure request format matches the examples
4. Check Supabase Edge Functions logs for detailed error messages

---

**Last Updated:** January 2025
